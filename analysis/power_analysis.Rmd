---
title: "Power analysis for ASoC"
author: "Lifan Liang"
date: "2025-10-25"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

Here, we investigate the power of allele-specific analysis with two-sided binomial tests on read counts between two alleles by pooling all the reads from the heterozygote individuals.

```{r, echo=F}
library(data.table)

asoc.store <- ("/Users/lifanliang/Documents/neuron_stim/results_100_lines_22Dec2023/")

asocfs <- list.files(asoc.store)
asocs <- list()
for(f in asocfs) {
  n <- substr(f,1,nchar(asocfs)-18)
  asocs[[n]] <- fread(paste0(asoc.store,f))
}
```

### Median of reads per cell line

From the previous analysis results on allele-specific open chromatin (ASoC), each heterozygote sample added 10 reads to the total coverage on median. This is the same across all the context for ASoC results.

```{r, echo=F}
sapply(asocs, function(x){median(x$DP/x$NCALLED)})
```

### Distribution of reference ratio.

The distribution of reference ratio at FDR<5% is bimodal, with the mode around 0.35 and 0.6.

```{r,echo=F}
hist(asocs[[1]]$REF_ratio[asocs[[1]]$FDR<0.05],breaks = 100,main = NA, xlab="Proportion of read counts on the reference allele")
```

We "folded" the reference ratio so only $[0.5,1.0]$ is shown. And then we computed the 10% and 90% quantile of the distribution. The ratio varies from 0.55 to 0.75. This range of ratio will be used in simulation experiments.

```{r,echo=F}
quant.bias <- function(x) {
  x[x<0.5] <- 1-x[x<0.5]
  quantile(x,c(0.1,0.9))
}
quant.bias(asocs[[1]]$REF_ratio[asocs[[1]]$FDR<0.05])
DT::datatable(t(sapply(asocs, function(x) {quant.bias(x$REF_ratio[x$FDR<0.05])})))
```


### The nominal P value cutoff for significant ASoC

The table below shows the largest P values for significant ASoC with FDR<5% as cutoff. We will use P=0.001 as the significance threshold for the simulation.

```{r, echo=F}
sapply(asocs, function(x){max(x$pVal[x$FDR<0.05])})
```



## Simulation 

Read count on two alleles was generated with a Binomial distribution. The synthetic experiment only has two parameters. One is the number of trails. This represents the total coverage that increases with sample size ($N_{read}=N_{sample} \times 10$). The other is the success probability, which represents the allele-specific effect size.

### Comparing two different effective sample sizes

Given that there are two cohorts, one has 38 heterozygote individuals and the other 143. The success probability takes a value in the range of$[0.55,0.75]$ with the step of 0.025. For each combination of sample size and effect size, we sampled 200 "loci" from the The distribution and run the Binomial test. The statistical power of the binomial test is calculated as the proportion of loci with P value < 0.001 in each setting.

```{r, echo=T}

# Generate the data and 
ratio <- 22:30 * 0.025
N_sample <- c(38,143)
N_trial <- 100
power <- matrix(nrow=length(N_sample), ncol=length(ratio))
colnames(power) <- ratio
rownames(power) <- N_sample
for(i in ratio) {
  for(j in N_sample){
    temp <- rep(0,N_trial)
    x <- rbinom(N_trial,j*10,i)
    for(k in 1:N_trial) {
      temp[k] <- binom.test(x[k],j*10,0.5,"two.sided")$p.value<0.001
    }
    power[as.character(j),as.character(i)] <- mean(temp)
  }
}

# Plot legend in first row
layout(matrix(c(1, 2), nrow = 2), heights = c(1.2, 5))
par(mar = c(0, 0, 0, 0))  # No margins
plot.new()
legend("center", legend = N_sample, col = 1:2, lty = 1, lwd=3, horiz = T,
       bty="n", title = "Sample size")
par(mar = c(5, 4, 0, 2))
matplot(t(power), xaxt='n', xlab="allelic bias", type = "l", lty = 1, col = 1:2,
        lwd=3, ylab="statistical power")
axis(side=1, at=1:ncol(power), labels=colnames(power))
```

### Comparing different total sample sizes with different minor allele frequence (MAF)

Given the total sample size of 38 and 143 and the MAF, we sampled the number of heterozygote individuals for each loci and then sampled the read counts given various allelic bias.

#### MAF=10%

```{r, echo=F}
set.seed(12345)
# Generate the data and 
ratio <- 22:30 * 0.025
N_total <- c(38,143) # Represents total samples here
N_trial <- 100
maf <- 0.1 # The minor allele frequency
power1 <- matrix(nrow=length(N_sample), ncol=length(ratio))
colnames(power1) <- ratio
rownames(power1) <- N_sample
for(i in ratio) {
  for(j in N_total){
    temp <- rep(0,N_trial)
    for(k in 1:N_trial) {
      N_het <- sum(rbinom(j,2,maf)==1) # Sample the ffective samle size first
      x <- rbinom(1,N_het*10,i)  # Sample the reads from the loci second
      temp[k] <- binom.test(x,N_het*10,0.5,"two.sided")$p.value<0.001
    }
    power1[as.character(j),as.character(i)] <- mean(temp)
  }
}

# Plot legend in first row
layout(matrix(c(1, 2), nrow = 2), heights = c(1.2, 5))
par(mar = c(0, 0, 0, 0))  # No margins
plot.new()
legend("center", legend = N_sample, col = 1:2, lty = 1, lwd=3, horiz = T,
       bty="n", title = "Sample size")
par(mar = c(5, 4, 0, 2))
matplot(t(power1), xaxt='n', xlab="allelic bias", type = "l", lty = 1, col = 1:2,
        lwd=3, ylab="statistical power")
axis(side=1, at=1:ncol(power), labels=colnames(power))
```


#### MAF=20%
```{r, echo=F}
set.seed(12345)
# Generate the data and 
ratio <- 22:30 * 0.025
N_total <- c(38,143) # Represents total samples here
N_trial <- 100
maf <- 0.2
power2 <- matrix(nrow=length(N_sample), ncol=length(ratio))
colnames(power2) <- ratio
rownames(power2) <- N_sample
for(i in ratio) {
  for(j in N_total){
    temp <- rep(0,N_trial)
    for(k in 1:N_trial) {
      N_het <- sum(rbinom(j,2,maf)==1) # Sample the ffective samle size first
      x <- rbinom(1,N_het*10,i)  # Sample the reads from the loci second
      temp[k] <- binom.test(x,N_het*10,0.5,"two.sided")$p.value<0.001
    }
    power2[as.character(j),as.character(i)] <- mean(temp)
  }
}

# Plot legend in first row
layout(matrix(c(1, 2), nrow = 2), heights = c(1.2, 5))
par(mar = c(0, 0, 0, 0))  # No margins
plot.new()
legend("center", legend = N_sample, col = 1:2, lty = 1, lwd=3, horiz = T,
       bty="n", title = "Sample size")
par(mar = c(5, 4, 0, 2))
matplot(t(power2), xaxt='n', xlab="allelic bias", type = "l", lty = 1, col = 1:2,
        lwd=3, ylab="statistical power")
axis(side=1, at=1:ncol(power), labels=colnames(power))
```

#### MAF=30%
```{r, echo=F}
set.seed(12345)
# Generate the data and 
ratio <- 22:30 * 0.025
N_total <- c(38,143) # Represents total samples here
N_trial <- 100
maf <- 0.3
power3 <- matrix(nrow=length(N_sample), ncol=length(ratio))
colnames(power3) <- ratio
rownames(power3) <- N_sample
for(i in ratio) {
  for(j in N_total){
    temp <- rep(0,N_trial)
    for(k in 1:N_trial) {
      N_het <- sum(rbinom(j,2,maf)==1) # Sample the ffective samle size first
      x <- rbinom(1,N_het*10,i)  # Sample the reads from the loci second
      temp[k] <- binom.test(x,N_het*10,0.5,"two.sided")$p.value<0.001
    }
    power3[as.character(j),as.character(i)] <- mean(temp)
  }
}

# Plot legend in first row
layout(matrix(c(1, 2), nrow = 2), heights = c(1.2, 5))
par(mar = c(0, 0, 0, 0))  # No margins
plot.new()
legend("center", legend = N_sample, col = 1:2, lty = 1, lwd=3, horiz = T,
       bty="n", title = "Sample size")
par(mar = c(5, 4, 0, 2))
matplot(t(power3), xaxt='n', xlab="allelic bias", type = "l", lty = 1, col = 1:2,
        lwd=3, ylab="statistical power")
axis(side=1, at=1:ncol(power), labels=colnames(power))
```


#### MAF=40%
```{r, echo=F}
set.seed(12345)
# Generate the data and 
ratio <- 22:30 * 0.025
N_total <- c(38,143) # Represents total samples here
N_trial <- 100
maf <- 0.4 # The minor allele frequency
power4 <- matrix(nrow=length(N_sample), ncol=length(ratio))
colnames(power4) <- ratio
rownames(power4) <- N_sample
for(i in ratio) {
  for(j in N_total){
    temp <- rep(0,N_trial)
    for(k in 1:N_trial) {
      N_het <- sum(rbinom(j,2,maf)==1) # Sample the ffective samle size first
      x <- rbinom(1,N_het*10,i)  # Sample the reads from the loci second
      temp[k] <- binom.test(x,N_het*10,0.5,"two.sided")$p.value<0.001
    }
    power4[as.character(j),as.character(i)] <- mean(temp)
  }
}

# Plot legend in first row
layout(matrix(c(1, 2), nrow = 2), heights = c(1.2, 5))
par(mar = c(0, 0, 0, 0))  # No margins
plot.new()
legend("center", legend = N_sample, col = 1:2, lty = 1, lwd=3, horiz = T,
       bty="n", title = "Sample size")
par(mar = c(5, 4, 0, 2))
matplot(t(power4), xaxt='n', xlab="allelic bias", type = "l", lty = 1, col = 1:2,
        lwd=3, ylab="statistical power")
axis(side=1, at=1:ncol(power), labels=colnames(power))
```


#### Comparison across MAF by averaging power among allele bias

```{r,echo=F}

library(ggplot2)
library(tidyr)


power.af <- cbind(rowMeans(power1),rowMeans(power2),rowMeans(power3),rowMeans(power4))
colnames(power.af) <- c("10%","20%","30%","40%")

data_long <- pivot_longer(as.data.frame(t(power.af)), cols = c("38", "143"),
                          names_to = "Sample_size", values_to = "Power")
data_long$MAF <- rep(colnames(power.af),each=2)

# Create grouped barplot

ggplot(data_long, aes(x = MAF, y = Power, fill = Sample_size)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "minor allele frequency", y = "statistical Power", fill = "sample size") +
  scale_fill_manual(values = c("#1f77b4", "#ff7f0e")) +
  theme_minimal() +
  theme(legend.position = "top") + 
  theme(
    legend.position = "top",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14)
  )

#ggsave("/Users/lifanliang/Documents/neuron_stim/asoc_power_comparison.pdf",width = 3.5,height = 3)

```



